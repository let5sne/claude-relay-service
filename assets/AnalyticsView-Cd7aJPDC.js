import{r as $,q as N,x as d,y as i,z as t,K as C,aV as M,aT as O,P as o,Q as L,ac as B,C as T,c as W,L as D,O as R,aX as st,o as at,V as ot,_ as et,Y as X,aq as V,B as H,D as lt,I as J,S as tt,R as G}from"./vue-vendor-Bsazo-x0.js";import{c as A,s as z,a as rt,_ as Y}from"./index-BgEU0IMx.js";import{C as nt}from"./chart-D0-mP5KW.js";import{R as it}from"./vendor-CrxIEVZC.js";import"./element-plus-DcHmMMW3.js";const dt={class:"cost-efficiency-analysis"},ut={class:"card p-6"},ct={class:"mb-6 flex items-center justify-between"},gt={class:"flex gap-3"},xt={key:0,class:"flex h-64 items-center justify-center"},pt={key:1},yt={class:"mb-6 grid grid-cols-1 gap-4 md:grid-cols-3"},mt={class:"rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 p-4 dark:from-blue-900/20 dark:to-indigo-900/20"},vt={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},ft={class:"rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 p-4 dark:from-green-900/20 dark:to-emerald-900/20"},bt={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},kt={class:"rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 p-4 dark:from-purple-900/20 dark:to-pink-900/20"},ht={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},$t={class:"overflow-x-auto"},_t={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},wt={class:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"},Ct={class:"px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100"},Pt={class:"px-4 py-3 text-sm text-gray-600 dark:text-gray-400"},Ft={class:"rounded-full bg-blue-100 px-2 py-1 text-xs dark:bg-blue-900/30"},St={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},At={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Tt={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Ut={class:"px-4 py-3 text-right text-sm font-medium text-gray-900 dark:text-gray-100"},Vt={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Dt={key:2,class:"flex flex-col items-center justify-center py-12"},Rt={__name:"CostEfficiencyAnalysis",setup(P){const f=$(!1),x=$({range:"30d",platform:"all"}),k=$({}),c=$([]),a=y=>y>=1e6?(y/1e6).toFixed(2)+"M":y>=1e3?(y/1e3).toFixed(2)+"K":(y==null?void 0:y.toString())||"0",b=async()=>{var y,m;f.value=!0;try{const F={...x.value};console.log("🔍 Loading cost efficiency data with params:",F);const[u,s]=await Promise.all([A.get("/admin/dashboard/cost-efficiency/summary",{params:F}),A.get("/admin/dashboard/cost-efficiency/accounts",{params:{...F,limit:50}})]);console.log("📊 Summary response:",u),console.log("📋 Accounts response:",s),u!=null&&u.success?(k.value=u.data||{},console.log("✅ Summary data loaded:",k.value)):(console.warn("⚠️ Summary response missing success flag:",u),k.value={}),s!=null&&s.success?(c.value=((y=s.data)==null?void 0:y.items)||[],console.log("✅ Accounts data loaded:",c.value.length,"items")):(console.warn("⚠️ Accounts response missing success flag:",s),c.value=[]),((m=u==null?void 0:u.data)==null?void 0:m.available)===!1&&z("数据库未启用,无法加载统计数据","warning")}catch(F){console.error("❌ Failed to load cost efficiency data:",F),z("加载性价比数据失败: "+(F.message||"未知错误"),"error"),k.value={},c.value=[]}finally{f.value=!1}};return N(()=>{b()}),(y,m)=>{var F,u,s;return i(),d("div",dt,[t("div",ut,[t("div",ct,[m[4]||(m[4]=t("div",null,[t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"账户性价比对比"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"}," 对比不同账户的成本效率和使用情况 ")],-1)),t("div",gt,[C(t("select",{"onUpdate:modelValue":m[0]||(m[0]=e=>x.value.range=e),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:b},m[2]||(m[2]=[t("option",{value:"today"},"今日",-1),t("option",{value:"7days"},"7天",-1),t("option",{value:"30d"},"30天",-1),t("option",{value:"total"},"全部",-1)]),544),[[M,x.value.range]]),C(t("select",{"onUpdate:modelValue":m[1]||(m[1]=e=>x.value.platform=e),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:b},m[3]||(m[3]=[O('<option value="all">全部平台</option><option value="claude">Claude</option><option value="claude-console">Console</option><option value="gemini">Gemini</option><option value="openai">OpenAI</option>',5)]),544),[[M,x.value.platform]])])]),f.value?(i(),d("div",xt,m[5]||(m[5]=[t("div",{class:"loading-spinner h-12 w-12 border-4 border-indigo-500"},null,-1)]))):c.value.length>0||k.value.totals?(i(),d("div",pt,[t("div",yt,[t("div",mt,[m[6]||(m[6]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"总账户数",-1)),t("div",vt,o(((F=k.value.totals)==null?void 0:F.accountCount)||0),1)]),t("div",ft,[m[7]||(m[7]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"平均成本/百万Token",-1)),t("div",bt," $"+o((((u=k.value.totals)==null?void 0:u.costPerMillion)||0).toFixed(2)),1)]),t("div",kt,[m[8]||(m[8]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"平均成功率",-1)),t("div",ht,o(((((s=k.value.totals)==null?void 0:s.successRate)||0)*100).toFixed(1))+"% ",1)])]),t("div",$t,[t("table",_t,[m[9]||(m[9]=t("thead",{class:"bg-gray-50 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 账户 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 平台 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 请求数 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总Token "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总成本 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 成本/百万Token "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 成功率 ")])],-1)),t("tbody",wt,[(i(!0),d(L,null,B(c.value,e=>(i(),d("tr",{key:e.accountId,class:"hover:bg-gray-50 dark:hover:bg-gray-800"},[t("td",Ct,o(e.accountName),1),t("td",Pt,[t("span",Ft,o(e.platform),1)]),t("td",St,o(a(e.totalRequests)),1),t("td",At,o(a(e.totalTokens)),1),t("td",Tt," $"+o((e.totalCost||0).toFixed(6)),1),t("td",Ut," $"+o((e.costPerMillion||0).toFixed(2)),1),t("td",Vt,[t("span",{class:T(["rounded-full px-2 py-1 text-xs",e.successRate>=.95?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":e.successRate>=.8?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300":"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"])},o(((e.successRate||0)*100).toFixed(1))+"% ",3)])]))),128))])])])])):(i(),d("div",Dt,m[10]||(m[10]=[O('<div class="mb-4 text-6xl">📊</div><h3 class="mb-2 text-lg font-semibold text-gray-900 dark:text-gray-100">暂无数据</h3><p class="mb-4 text-center text-sm text-gray-600 dark:text-gray-400"> 当前时间范围内没有找到账户使用数据 </p><div class="text-xs text-gray-500 dark:text-gray-500"><p>可能的原因:</p><ul class="mt-2 list-inside list-disc space-y-1"><li>数据库未启用或未配置</li><li>选择的时间范围内没有使用记录</li><li>所有账户都被筛选条件排除</li></ul></div>',4)])))])])}}},It={class:"api-key-breakdown-analysis"},qt={class:"card p-6"},Mt={class:"mb-6 flex items-center justify-between"},Lt={class:"flex gap-3"},Bt=["value"],Kt={key:0,class:"flex h-64 items-center justify-center"},jt={key:1,class:"flex h-64 flex-col items-center justify-center text-gray-500"},zt={key:2},Et={class:"mb-6 grid grid-cols-1 gap-4 md:grid-cols-3"},Nt={class:"rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 p-4 dark:from-blue-900/20 dark:to-indigo-900/20"},Ot={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},Yt={class:"rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 p-4 dark:from-green-900/20 dark:to-emerald-900/20"},Qt={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},Gt={class:"rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 p-4 dark:from-purple-900/20 dark:to-pink-900/20"},Ht={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},Wt={class:"overflow-x-auto"},Xt={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},Zt={class:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"},Jt=["onClick"],te={class:"px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100"},ee={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},se={class:"px-4 py-3 text-right text-sm text-gray-600 dark:text-gray-400"},ae={class:"px-4 py-3 text-right text-sm text-gray-600 dark:text-gray-400"},oe={class:"px-4 py-3 text-right text-sm text-gray-600 dark:text-gray-400"},le={class:"px-4 py-3 text-right text-sm text-gray-600 dark:text-gray-400"},re={class:"px-4 py-3 text-right text-sm font-medium text-gray-900 dark:text-gray-100"},ne={class:"px-4 py-3 text-right text-sm font-medium text-gray-900 dark:text-gray-100"},ie={class:"px-4 py-3 text-sm text-gray-600 dark:text-gray-400"},de={class:"bg-gray-50 px-4 py-4 dark:bg-gray-800/50",colspan:"9"},ue={key:0,class:"flex justify-center py-4"},ce={key:1,class:"space-y-2"},ge={class:"mb-2 text-sm font-medium text-gray-700 dark:text-gray-300"},xe={class:"max-h-96 overflow-y-auto"},pe={class:"min-w-full text-xs"},ye={class:"divide-y divide-gray-200 dark:divide-gray-600"},me={class:"px-3 py-2 text-gray-700 dark:text-gray-300"},ve={class:"px-3 py-2 text-gray-700 dark:text-gray-300"},fe={class:"px-3 py-2 text-right text-gray-600 dark:text-gray-400"},be={class:"px-3 py-2 text-right text-gray-600 dark:text-gray-400"},ke={class:"px-3 py-2 text-right text-gray-600 dark:text-gray-400"},he={class:"px-3 py-2 text-right text-gray-600 dark:text-gray-400"},$e={class:"px-3 py-2 text-right font-medium text-gray-900 dark:text-gray-100"},_e={class:"px-3 py-2 text-right font-medium text-gray-900 dark:text-gray-100"},we={class:"px-3 py-2 text-center"},Ce={key:0,class:"rounded bg-yellow-100 px-2 py-1 text-xs text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300",title:"此请求的 token 数据需要人工核对"},Pe={key:1,class:"rounded bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",title:"此记录已手动更新"},Fe={key:2,class:"rounded bg-green-100 px-2 py-1 text-xs text-green-800 dark:bg-green-900/30 dark:text-green-300"},Se={key:2,class:"py-4 text-center text-sm text-gray-500"},Ae={key:3,class:"flex h-64 flex-col items-center justify-center text-gray-500"},Te={__name:"ApiKeyBreakdownAnalysis",setup(P){const f=$(!1),x=$([]),k=$(""),c=$({range:"30d"}),a=$([]),b=$(new Set),y=$({}),m=$({}),F=W(()=>a.value.reduce((l,p)=>l+(p.requests||0),0)),u=W(()=>a.value.reduce((l,p)=>l+(p.totalCost||0),0)),s=l=>l>=1e6?(l/1e6).toFixed(2)+"M":l>=1e3?(l/1e3).toFixed(2)+"K":(l==null?void 0:l.toString())||"0",e=l=>{if(!l)return"-";const p=new Date(l);return Number.isNaN(p.getTime())?l:`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}-${String(p.getDate()).padStart(2,"0")} ${String(p.getHours()).padStart(2,"0")}:${String(p.getMinutes()).padStart(2,"0")}`},r=l=>{if(!l)return"-";const p=new Date(l);if(Number.isNaN(p.getTime()))return l;const _=String(p.getMonth()+1).padStart(2,"0"),q=String(p.getDate()).padStart(2,"0"),v=String(p.getHours()).padStart(2,"0"),h=String(p.getMinutes()).padStart(2,"0"),g=String(p.getSeconds()).padStart(2,"0");return`${_}-${q} ${v}:${h}:${g}`},U=async()=>{try{console.log("🔍 Loading accounts for API key breakdown");const l=await A.get("/admin/accounts/usage-stats",{params:{range:"total"}});console.log("📋 Accounts response:",l),l!=null&&l.success?(x.value=l.data||[],console.log("✅ Accounts loaded:",x.value.length,"accounts")):(console.warn("⚠️ Accounts response missing success flag:",l),x.value=[])}catch(l){console.error("❌ Failed to load accounts:",l),z("加载账户列表失败: "+(l.message||"未知错误"),"error"),x.value=[]}},I=async()=>{if(!k.value){a.value=[];return}f.value=!0;try{console.log("🔍 Loading API key breakdown for account:",k.value);const l=await A.get(`/admin/accounts/${k.value}/usage-breakdown`,{params:{...c.value,limit:100}});console.log("🔑 Breakdown response:",l),l!=null&&l.success?(a.value=l.items||[],console.log("✅ Breakdown loaded:",a.value.length,"API keys"),b.value.clear(),m.value={}):(console.warn("⚠️ Breakdown response missing success flag:",l),a.value=[])}catch(l){console.error("❌ Failed to load API key breakdown:",l),z("加载 API Key 明细失败: "+(l.message||"未知错误"),"error"),a.value=[]}finally{f.value=!1}},w=async l=>{b.value.has(l)?(b.value.delete(l),b.value=new Set(b.value)):(b.value.add(l),b.value=new Set(b.value),await n(l))},n=async l=>{y.value[l]=!0;try{const p=await A.get(`/admin/api-keys/${l}/usage-details`,{params:{range:c.value.range,limit:50}});p.success&&(m.value[l]=p.items||[])}catch{z("加载请求详情失败","error"),m.value[l]=[]}finally{y.value[l]=!1}};return N(()=>{U()}),(l,p)=>(i(),d("div",It,[t("div",qt,[t("div",Mt,[p[4]||(p[4]=t("div",null,[t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"API Key 调用明细"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"}," 查看每个 API Key 的详细调用统计 ")],-1)),t("div",Lt,[C(t("select",{"onUpdate:modelValue":p[0]||(p[0]=_=>k.value=_),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:I},[p[2]||(p[2]=t("option",{value:""},"选择账户",-1)),(i(!0),d(L,null,B(x.value,_=>(i(),d("option",{key:_.id,value:_.id},o(_.name)+" ("+o(_.platform)+") ",9,Bt))),128))],544),[[M,k.value]]),C(t("select",{"onUpdate:modelValue":p[1]||(p[1]=_=>c.value.range=_),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:I},p[3]||(p[3]=[t("option",{value:"today"},"今日",-1),t("option",{value:"7days"},"7天",-1),t("option",{value:"30d"},"30天",-1),t("option",{value:"total"},"全部",-1)]),544),[[M,c.value.range]])])]),f.value?(i(),d("div",Kt,p[5]||(p[5]=[t("div",{class:"loading-spinner h-12 w-12 border-4 border-indigo-500"},null,-1)]))):k.value?a.value.length>0?(i(),d("div",zt,[t("div",Et,[t("div",Nt,[p[7]||(p[7]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"API Key 总数",-1)),t("div",Ot,o(a.value.length),1)]),t("div",Yt,[p[8]||(p[8]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"总请求数",-1)),t("div",Qt,o(s(F.value)),1)]),t("div",Gt,[p[9]||(p[9]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"总成本",-1)),t("div",Ht," $"+o(u.value.toFixed(6)),1)])]),t("div",Wt,[t("table",Xt,[p[12]||(p[12]=t("thead",{class:"bg-gray-50 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," API Key "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 请求数 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 输入Token "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 输出Token "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 缓存创建 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 缓存读取 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总Token "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总成本 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 最后使用 ")])],-1)),t("tbody",Zt,[(i(!0),d(L,null,B(a.value,_=>{var q;return i(),d(L,{key:_.apiKeyId},[t("tr",{class:"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800",onClick:v=>w(_.apiKeyId)},[t("td",te,[t("i",{class:T(["mr-2 text-xs text-gray-400",b.value.has(_.apiKeyId)?"fas fa-chevron-down":"fas fa-chevron-right"])},null,2),R(" "+o(_.apiKeyName),1)]),t("td",ee,o(s(_.requests)),1),t("td",se,o(s(_.inputTokens)),1),t("td",ae,o(s(_.outputTokens)),1),t("td",oe,o(s(_.cacheCreateTokens||0)),1),t("td",le,o(s(_.cacheReadTokens||0)),1),t("td",re,o(s(_.totalTokens)),1),t("td",ne," $"+o((_.totalCost||0).toFixed(6)),1),t("td",ie,o(e(_.lastUsedAt)),1)],8,Jt),b.value.has(_.apiKeyId)?(i(),d("tr",{key:`${_.apiKeyId}-details`},[t("td",de,[y.value[_.apiKeyId]?(i(),d("div",ue,p[10]||(p[10]=[t("div",{class:"loading-spinner h-8 w-8 border-4 border-indigo-500"},null,-1)]))):((q=m.value[_.apiKeyId])==null?void 0:q.length)>0?(i(),d("div",ce,[t("div",ge," 详细请求记录 (最近 "+o(m.value[_.apiKeyId].length)+" 条) ",1),t("div",xe,[t("table",pe,[p[11]||(p[11]=t("thead",{class:"bg-gray-100 dark:bg-gray-700"},[t("tr",null,[t("th",{class:"px-3 py-2 text-left text-gray-600 dark:text-gray-300"}," 时间 "),t("th",{class:"px-3 py-2 text-left text-gray-600 dark:text-gray-300"}," 模型 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 输入 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 输出 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 缓存创建 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 缓存读取 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 总计 "),t("th",{class:"px-3 py-2 text-right text-gray-600 dark:text-gray-300"}," 费用 "),t("th",{class:"px-3 py-2 text-center text-gray-600 dark:text-gray-300"}," 状态 ")])],-1)),t("tbody",ye,[(i(!0),d(L,null,B(m.value[_.apiKeyId],v=>{var h,g;return i(),d("tr",{key:v.id,class:"hover:bg-gray-100 dark:hover:bg-gray-700"},[t("td",me,o(r(v.occurred_at)),1),t("td",ve,o(v.model),1),t("td",fe,o(v.input_tokens),1),t("td",be,o(v.output_tokens),1),t("td",ke,o(v.cache_create_tokens),1),t("td",he,o(v.cache_read_tokens),1),t("td",$e,o(v.total_tokens),1),t("td",_e," $"+o(parseFloat(v.total_cost||0).toFixed(6)),1),t("td",we,[(h=v.metadata)!=null&&h._no_usage_data?(i(),d("span",Ce," 需核对 ")):(g=v.metadata)!=null&&g._manually_updated?(i(),d("span",Pe," 已更新 ")):(i(),d("span",Fe," 正常 "))])])}),128))])])])])):(i(),d("div",Se,"暂无详细记录"))])])):D("",!0)],64)}),128))])])])])):(i(),d("div",Ae,p[13]||(p[13]=[t("i",{class:"fas fa-inbox mb-4 text-4xl"},null,-1),t("p",null,"该账户暂无 API Key 调用数据",-1)]))):(i(),d("div",jt,p[6]||(p[6]=[t("i",{class:"fas fa-key mb-4 text-4xl"},null,-1),t("p",null,"请选择一个账户查看 API Key 调用明细",-1)])))])]))}},Ue={class:"cost-trends-analysis"},Ve={class:"card p-6"},De={class:"mb-6 flex items-center justify-between"},Re={class:"flex gap-3"},Ie={key:0,class:"flex h-64 items-center justify-center"},qe={key:1,class:"flex h-64 flex-col items-center justify-center text-gray-500"},Me={key:2},Le={class:"mb-6 h-80"},Be={class:"grid grid-cols-1 gap-4 md:grid-cols-4"},Ke={class:"rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 p-4 dark:from-blue-900/20 dark:to-indigo-900/20"},je={class:"mt-1 text-xl font-bold text-gray-900 dark:text-gray-100"},ze={class:"rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 p-4 dark:from-green-900/20 dark:to-emerald-900/20"},Ee={class:"mt-1 text-xl font-bold text-gray-900 dark:text-gray-100"},Ne={class:"rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 p-4 dark:from-purple-900/20 dark:to-pink-900/20"},Oe={class:"mt-1 text-xl font-bold text-gray-900 dark:text-gray-100"},Ye={class:"rounded-lg bg-gradient-to-br from-orange-50 to-red-50 p-4 dark:from-orange-900/20 dark:to-red-900/20"},Qe={__name:"CostTrendsAnalysis",setup(P){const f=rt(),{isDarkMode:x}=st(f),k=$(!1),c=$(null);let a=null;const b=$({range:"30d",interval:"day"}),y=$([]),m=W(()=>{if(y.value.length===0)return{totalCost:0,avgCost:0,maxCost:0,growthRate:0};const s=y.value.map(l=>l.totalCost||l.cost||0),e=s.reduce((l,p)=>l+p,0),r=e/s.length,U=Math.max(...s),I=s[0]||0,w=s[s.length-1]||0,n=I>0?(w-I)/I*100:0;return{totalCost:e,avgCost:r,maxCost:U,growthRate:n}}),F=async()=>{var s,e;k.value=!0;try{console.log("🔍 Loading cost trends with params:",b.value);const r=await A.get("/admin/dashboard/cost-efficiency/trends",{params:b.value});console.log("📈 Trends response:",r),r!=null&&r.success?(y.value=((s=r.data)==null?void 0:s.data)||[],console.log("✅ Trends data loaded:",y.value.length,"data points"),u()):(console.warn("⚠️ Trends response missing success flag:",r),y.value=[]),((e=r==null?void 0:r.data)==null?void 0:e.available)===!1&&z("数据库未启用,无法加载趋势数据","warning")}catch(r){console.error("❌ Failed to load cost trends:",r),z("加载趋势数据失败: "+(r.message||"未知错误"),"error"),y.value=[]}finally{k.value=!1}},u=()=>{if(!c.value||y.value.length===0)return;a&&a.destroy();const s=y.value.map(r=>r.timestamp?new Date(r.timestamp).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"}):r.date||r.label||""),e=y.value.map(r=>r.totalCost||r.cost||0);a=new nt(c.value,{type:"line",data:{labels:s,datasets:[{label:"成本",data:e,borderColor:"rgb(99, 102, 241)",backgroundColor:"rgba(99, 102, 241, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:r=>`成本: $${r.parsed.y.toFixed(6)}`}}},scales:{y:{beginAtZero:!0,ticks:{callback:r=>`$${r.toFixed(6)}`,color:x.value?"#9ca3af":"#6b7280"},grid:{color:x.value?"rgba(75, 85, 99, 0.3)":"rgba(0, 0, 0, 0.1)"}},x:{ticks:{color:x.value?"#9ca3af":"#6b7280"},grid:{color:x.value?"rgba(75, 85, 99, 0.3)":"rgba(0, 0, 0, 0.1)"}}}}})};return at(x,()=>{u()}),N(()=>{F()}),ot(()=>{a&&a.destroy()}),(s,e)=>(i(),d("div",Ue,[t("div",Ve,[t("div",De,[e[4]||(e[4]=t("div",null,[t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"成本趋势分析"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"},"查看成本变化趋势和预测")],-1)),t("div",Re,[C(t("select",{"onUpdate:modelValue":e[0]||(e[0]=r=>b.value.range=r),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:F},e[2]||(e[2]=[t("option",{value:"7days"},"7天",-1),t("option",{value:"30d"},"30天",-1),t("option",{value:"90d"},"90天",-1)]),544),[[M,b.value.range]]),C(t("select",{"onUpdate:modelValue":e[1]||(e[1]=r=>b.value.interval=r),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",onChange:F},e[3]||(e[3]=[t("option",{value:"hour"},"按小时",-1),t("option",{value:"day"},"按天",-1),t("option",{value:"week"},"按周",-1)]),544),[[M,b.value.interval]])])]),k.value?(i(),d("div",Ie,e[5]||(e[5]=[t("div",{class:"loading-spinner h-12 w-12 border-4 border-indigo-500"},null,-1)]))):y.value.length===0?(i(),d("div",qe,e[6]||(e[6]=[t("div",{class:"mb-4 text-6xl"},"📈",-1),t("h3",{class:"mb-2 text-lg font-semibold text-gray-900 dark:text-gray-100"},"暂无趋势数据",-1),t("p",{class:"text-center text-sm text-gray-600 dark:text-gray-400"}," 当前时间范围内没有找到成本趋势数据 ",-1)]))):(i(),d("div",Me,[t("div",Le,[t("canvas",{ref_key:"chartCanvas",ref:c},null,512)]),t("div",Be,[t("div",Ke,[e[7]||(e[7]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"总成本",-1)),t("div",je," $"+o(m.value.totalCost.toFixed(6)),1)]),t("div",ze,[e[8]||(e[8]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"平均成本",-1)),t("div",Ee," $"+o(m.value.avgCost.toFixed(6)),1)]),t("div",Ne,[e[9]||(e[9]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"最高成本",-1)),t("div",Oe," $"+o(m.value.maxCost.toFixed(6)),1)]),t("div",Ye,[e[10]||(e[10]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"增长率",-1)),t("div",{class:T(["mt-1 text-xl font-bold",m.value.growthRate>=0?"text-red-600":"text-green-600"])},o(m.value.growthRate>=0?"+":"")+o(m.value.growthRate.toFixed(1))+"% ",3)])])]))])]))}},j="/admin",E={async getAccountCostProfile(P){return(await A.get(`${j}/accounts/${P}/cost-profile`)).data},async updateCostProfile(P,f){return(await A.put(`${j}/accounts/${P}/cost-profile`,f)).data},async createBill(P,f){return(await A.post(`${j}/accounts/${P}/bills`,f)).data},async listBills(P,f={}){return(await A.get(`${j}/accounts/${P}/bills`,{params:{limit:f.limit||20,offset:f.offset||0}})).data},async inferPricing(P){return(await A.post(`${j}/accounts/${P}/infer-pricing`)).data},async validateCosts(P,f){return(await A.post(`${j}/accounts/${P}/validate-costs`,{billingPeriod:f})).data},async getCostComparison(P,f,x){return(await A.get(`${j}/accounts/${P}/cost-comparison`,{params:{startDate:f,endDate:x}})).data},async importBillsCSV(P,f){return(await A.post(`${j}/accounts/${P}/bills/import`,f,{headers:{"Content-Type":"multipart/form-data"}})).data}},Ge={class:"modal-content"},He={class:"modal-header"},We={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},Xe={class:"modal-body"},Ze={class:"mb-6"},Je={class:"mb-6"},ts={key:0,class:"config-section"},es={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},ss={key:1,class:"config-section"},as={class:"grid grid-cols-1 gap-4 md:grid-cols-3"},os=["onUpdate:modelValue"],ls=["onUpdate:modelValue"],rs=["onUpdate:modelValue"],ns=["onClick"],is={key:2,class:"config-section"},ds={class:"mb-4"},us={class:"mb-4"},cs={class:"mb-4"},gs={key:3,class:"config-section"},xs={class:"mb-4"},ps={class:"config-section"},ys={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},ms={class:"mb-6"},vs={class:"modal-footer"},fs=["disabled"],bs={__name:"CostProfileModal",props:{account:{type:Object,required:!0}},emits:["close","saved"],setup(P,{emit:f}){const x=P,k=f,c=$(!1),a=et({billingType:"standard",confidenceLevel:"low",pointConversion:{pointsPerRequest:1,pointsPerToken:.001,costPerPoint:.01},tieredPricing:[{minTokens:0,maxTokens:1e6,costPerMillion:3}],pricingFormula:{baseTokenCost:3e-6,perRequestFee:.002,weight:.5},relativeEfficiency:1,fixedCosts:{monthly_base:0,api_access_fee:0},notes:""});async function b(){if(!x.account.costProfile)return;const u=x.account.costProfile;a.billingType=u.billingType||"standard",a.confidenceLevel=u.confidenceLevel||"low",a.notes=u.notes||"",u.pointConversion&&(a.pointConversion={...u.pointConversion}),u.tieredPricing&&u.tieredPricing.length>0&&(a.tieredPricing=[...u.tieredPricing]),u.pricingFormula&&(a.pricingFormula={...u.pricingFormula}),u.relativeEfficiency&&(a.relativeEfficiency=u.relativeEfficiency),u.fixedCosts&&(a.fixedCosts={...u.fixedCosts})}function y(){a.tieredPricing.push({minTokens:0,maxTokens:1e6,costPerMillion:3})}function m(u){a.tieredPricing.splice(u,1)}async function F(){var u,s;c.value=!0;try{await E.updateCostProfile(x.account.id,a),k("saved")}catch(e){alert(`保存失败: ${((s=(u=e.response)==null?void 0:u.data)==null?void 0:s.error)||e.message}`)}finally{c.value=!1}}return N(()=>{b()}),(u,s)=>(i(),d("div",{class:"modal-overlay",onClick:s[14]||(s[14]=X(e=>u.$emit("close"),["self"]))},[t("div",Ge,[t("div",He,[t("h3",We," 成本配置 - "+o(P.account.name),1),t("button",{class:"close-btn",onClick:s[0]||(s[0]=e=>u.$emit("close"))},s[15]||(s[15]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",Xe,[t("form",{onSubmit:X(F,["prevent"])},[t("div",Ze,[s[17]||(s[17]=t("label",{class:"form-label"},"计价模式",-1)),C(t("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>a.billingType=e),class:"form-input"},s[16]||(s[16]=[O('<option value="standard" data-v-1a99438c>标准定价（使用公开价格表）</option><option value="point_based" data-v-1a99438c>积分制计费</option><option value="tiered" data-v-1a99438c>阶梯定价</option><option value="hybrid" data-v-1a99438c>混合计费</option><option value="estimated" data-v-1a99438c>估算模式</option>',5)]),512),[[M,a.billingType]]),s[18]||(s[18]=t("p",{class:"form-hint"},"选择账户的计费方式",-1))]),t("div",Je,[s[20]||(s[20]=t("label",{class:"form-label"},"置信度级别",-1)),C(t("select",{"onUpdate:modelValue":s[2]||(s[2]=e=>a.confidenceLevel=e),class:"form-input"},s[19]||(s[19]=[O('<option value="high" data-v-1a99438c>高 - 已验证准确</option><option value="medium-high" data-v-1a99438c>较高 - 多次验证</option><option value="medium" data-v-1a99438c>中等 - 部分验证</option><option value="low-medium" data-v-1a99438c>较低 - 少量验证</option><option value="low" data-v-1a99438c>低 - 未验证</option>',5)]),512),[[M,a.confidenceLevel]]),s[21]||(s[21]=t("p",{class:"form-hint"},"指示成本计算的可信程度",-1))]),a.billingType==="point_based"?(i(),d("div",ts,[s[25]||(s[25]=t("h4",{class:"section-title"},"积分换算配置",-1)),t("div",es,[t("div",null,[s[22]||(s[22]=t("label",{class:"form-label"},"每请求积分",-1)),C(t("input",{"onUpdate:modelValue":s[3]||(s[3]=e=>a.pointConversion.pointsPerRequest=e),class:"form-input",placeholder:"1",step:"0.001",type:"number"},null,512),[[V,a.pointConversion.pointsPerRequest,void 0,{number:!0}]])]),t("div",null,[s[23]||(s[23]=t("label",{class:"form-label"},"每Token积分",-1)),C(t("input",{"onUpdate:modelValue":s[4]||(s[4]=e=>a.pointConversion.pointsPerToken=e),class:"form-input",placeholder:"0.001",step:"0.00001",type:"number"},null,512),[[V,a.pointConversion.pointsPerToken,void 0,{number:!0}]])]),t("div",null,[s[24]||(s[24]=t("label",{class:"form-label"},"每积分成本 ($)",-1)),C(t("input",{"onUpdate:modelValue":s[5]||(s[5]=e=>a.pointConversion.costPerPoint=e),class:"form-input",placeholder:"0.01",step:"0.0001",type:"number"},null,512),[[V,a.pointConversion.costPerPoint,void 0,{number:!0}]])])])])):D("",!0),a.billingType==="tiered"?(i(),d("div",ss,[s[31]||(s[31]=t("h4",{class:"section-title"},"阶梯定价配置",-1)),(i(!0),d(L,null,B(a.tieredPricing,(e,r)=>(i(),d("div",{key:r,class:"tier-item"},[t("div",as,[t("div",null,[s[26]||(s[26]=t("label",{class:"form-label"},"最小Token",-1)),C(t("input",{"onUpdate:modelValue":U=>e.minTokens=U,class:"form-input",placeholder:"0",type:"number"},null,8,os),[[V,e.minTokens,void 0,{number:!0}]])]),t("div",null,[s[27]||(s[27]=t("label",{class:"form-label"},"最大Token",-1)),C(t("input",{"onUpdate:modelValue":U=>e.maxTokens=U,class:"form-input",placeholder:"1000000",type:"number"},null,8,ls),[[V,e.maxTokens,void 0,{number:!0}]])]),t("div",null,[s[28]||(s[28]=t("label",{class:"form-label"},"成本/百万Token ($)",-1)),C(t("input",{"onUpdate:modelValue":U=>e.costPerMillion=U,class:"form-input",placeholder:"3.0",step:"0.01",type:"number"},null,8,rs),[[V,e.costPerMillion,void 0,{number:!0}]])])]),a.tieredPricing.length>1?(i(),d("button",{key:0,class:"btn-sm btn-danger mt-2",type:"button",onClick:U=>m(r)},s[29]||(s[29]=[t("i",{class:"fas fa-trash"},null,-1),R(" 删除 ",-1)]),8,ns)):D("",!0)]))),128)),t("button",{class:"btn-secondary mt-2",type:"button",onClick:y},s[30]||(s[30]=[t("i",{class:"fas fa-plus"},null,-1),R(" 添加阶梯 ",-1)]))])):D("",!0),a.billingType==="hybrid"?(i(),d("div",is,[s[36]||(s[36]=t("h4",{class:"section-title"},"混合计费公式",-1)),t("div",ds,[s[32]||(s[32]=t("label",{class:"form-label"},"基础Token成本 ($)",-1)),C(t("input",{"onUpdate:modelValue":s[6]||(s[6]=e=>a.pricingFormula.baseTokenCost=e),class:"form-input",placeholder:"0.000003",step:"0.000001",type:"number"},null,512),[[V,a.pricingFormula.baseTokenCost,void 0,{number:!0}]])]),t("div",us,[s[33]||(s[33]=t("label",{class:"form-label"},"每请求固定费用 ($)",-1)),C(t("input",{"onUpdate:modelValue":s[7]||(s[7]=e=>a.pricingFormula.perRequestFee=e),class:"form-input",placeholder:"0.002",step:"0.0001",type:"number"},null,512),[[V,a.pricingFormula.perRequestFee,void 0,{number:!0}]])]),t("div",cs,[s[34]||(s[34]=t("label",{class:"form-label"},"权重系数",-1)),C(t("input",{"onUpdate:modelValue":s[8]||(s[8]=e=>a.pricingFormula.weight=e),class:"form-input",max:"1",min:"0",placeholder:"0.5",step:"0.1",type:"number"},null,512),[[V,a.pricingFormula.weight,void 0,{number:!0}]]),s[35]||(s[35]=t("p",{class:"form-hint"},"0-1之间，表示Token成本和请求费用的混合比例",-1))])])):D("",!0),a.billingType==="estimated"?(i(),d("div",gs,[s[39]||(s[39]=t("h4",{class:"section-title"},"估算参数",-1)),t("div",xs,[s[37]||(s[37]=t("label",{class:"form-label"},"相对效率系数",-1)),C(t("input",{"onUpdate:modelValue":s[9]||(s[9]=e=>a.relativeEfficiency=e),class:"form-input",placeholder:"1.0",step:"0.1",type:"number"},null,512),[[V,a.relativeEfficiency,void 0,{number:!0}]]),s[38]||(s[38]=t("p",{class:"form-hint"},"相对于标准价格的倍数（如0.8表示比标准便宜20%）",-1))])])):D("",!0),t("div",ps,[s[42]||(s[42]=t("h4",{class:"section-title"},"固定费用（可选）",-1)),t("div",ys,[t("div",null,[s[40]||(s[40]=t("label",{class:"form-label"},"月度基础费用 ($)",-1)),C(t("input",{"onUpdate:modelValue":s[10]||(s[10]=e=>a.fixedCosts.monthly_base=e),class:"form-input",placeholder:"0",step:"0.01",type:"number"},null,512),[[V,a.fixedCosts.monthly_base,void 0,{number:!0}]])]),t("div",null,[s[41]||(s[41]=t("label",{class:"form-label"},"API访问费 ($)",-1)),C(t("input",{"onUpdate:modelValue":s[11]||(s[11]=e=>a.fixedCosts.api_access_fee=e),class:"form-input",placeholder:"0",step:"0.01",type:"number"},null,512),[[V,a.fixedCosts.api_access_fee,void 0,{number:!0}]])])])]),t("div",ms,[s[43]||(s[43]=t("label",{class:"form-label"},"备注说明",-1)),C(t("textarea",{"onUpdate:modelValue":s[12]||(s[12]=e=>a.notes=e),class:"form-input",placeholder:"记录配置来源或特殊说明",rows:"3"},null,512),[[V,a.notes]])])],32)]),t("div",vs,[t("button",{class:"btn-secondary",type:"button",onClick:s[13]||(s[13]=e=>u.$emit("close"))},"取消"),t("button",{class:"btn-primary",disabled:c.value,type:"button",onClick:F},[t("i",{class:T(["fas fa-save",{"fa-spin":c.value}])},null,2),R(" "+o(c.value?"保存中...":"保存配置"),1)],8,fs)])])]))}},ks=Y(bs,[["__scopeId","data-v-1a99438c"]]),hs={class:"modal-content"},$s={class:"modal-header"},_s={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},ws={class:"modal-body"},Cs={key:0,class:"space-y-6"},Ps={class:"mb-4"},Fs={class:"mb-4"},Ss={class:"mb-4"},As={class:"mb-4"},Ts={class:"mb-4"},Us={class:"text-center"},Vs={key:1,class:"space-y-6"},Ds={key:0,class:"overflow-x-auto"},Rs={class:"min-w-full text-xs"},Is={class:"divide-y divide-gray-200 dark:divide-gray-700"},qs={class:"px-2 py-1"},Ms={class:"px-2 py-1 text-right"},Ls={class:"px-2 py-1"},Bs={class:"px-2 py-1 text-gray-600 dark:text-gray-400"},Ks={class:"mt-2 text-xs text-gray-500"},js={class:"text-center"},zs={class:"modal-footer"},Es=["disabled"],Ns={__name:"BillEntryModal",props:{account:{type:Object,required:!0}},emits:["close","saved"],setup(P,{emit:f}){const x=P,k=f,c=$(!1),a=$(!1),b=$([]),y=et({billingPeriod:"",totalCost:null,currency:"USD",notes:"",attachment:null});function m(s){const e=s.target.files[0];e&&(y.attachment=e)}function F(s){const e=s.target.files[0];if(!e)return;const r=new FileReader;r.onload=U=>{try{const w=U.target.result.split(`
`).filter(l=>l.trim()),n=w[0].split(",").map(l=>l.trim());b.value=w.slice(1).map(l=>{const p=l.split(",").map(q=>q.trim()),_={};return n.forEach((q,v)=>{_[q]=p[v]||""}),_})}catch(I){alert("CSV 解析失败: "+I.message)}},r.readAsText(e)}async function u(){var s,e;c.value=!0;try{if(a.value){for(const r of b.value)await E.createBill(x.account.id,{billingPeriod:r.billingPeriod,totalCost:parseFloat(r.totalCost),currency:r.currency||"USD",notes:r.notes||""});alert(`成功录入 ${b.value.length} 条账单`)}else await E.createBill(x.account.id,{billingPeriod:y.billingPeriod,totalCost:y.totalCost,currency:y.currency,notes:y.notes}),alert("账单录入成功");k("saved"),k("close")}catch(r){alert(`录入失败: ${((e=(s=r.response)==null?void 0:s.data)==null?void 0:e.error)||r.message}`)}finally{c.value=!1}}return(s,e)=>(i(),d("div",{class:"modal-overlay",onClick:e[8]||(e[8]=X(r=>s.$emit("close"),["self"]))},[t("div",hs,[t("div",$s,[t("h3",_s," 录入账单 - "+o(P.account.name),1),t("button",{class:"close-btn",onClick:e[0]||(e[0]=r=>s.$emit("close"))},e[9]||(e[9]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",ws,[a.value?(i(),d("div",Vs,[e[24]||(e[24]=O('<div class="rounded-lg bg-blue-50 p-4 dark:bg-blue-900/20" data-v-93b9649c><h4 class="mb-2 text-sm font-semibold text-blue-900 dark:text-blue-300" data-v-93b9649c><i class="fas fa-info-circle" data-v-93b9649c></i> CSV 格式说明 </h4><p class="mb-2 text-xs text-blue-800 dark:text-blue-400" data-v-93b9649c> CSV 文件应包含以下列（第一行为表头）： </p><code class="block rounded bg-white p-2 text-xs dark:bg-gray-800 dark:text-gray-300" data-v-93b9649c> billingPeriod,totalCost,currency,notes<br data-v-93b9649c> 2025-01,123.45,USD,一月账单<br data-v-93b9649c> 2025-02,145.67,USD,二月账单 </code></div>',1)),t("div",null,[e[20]||(e[20]=t("label",{class:"form-label"},"选择 CSV 文件",-1)),t("input",{accept:".csv",class:"form-input",type:"file",onChange:F},null,32)]),b.value.length>0?(i(),d("div",Ds,[e[22]||(e[22]=t("h4",{class:"mb-2 text-sm font-semibold text-gray-900 dark:text-gray-100"}," 预览（前5条） ",-1)),t("table",Rs,[e[21]||(e[21]=t("thead",{class:"bg-gray-50 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-2 py-1 text-left"},"计费周期"),t("th",{class:"px-2 py-1 text-right"},"金额"),t("th",{class:"px-2 py-1 text-left"},"币种"),t("th",{class:"px-2 py-1 text-left"},"备注")])],-1)),t("tbody",Is,[(i(!0),d(L,null,B(b.value.slice(0,5),(r,U)=>(i(),d("tr",{key:U},[t("td",qs,o(r.billingPeriod),1),t("td",Ms,"$"+o(r.totalCost),1),t("td",Ls,o(r.currency),1),t("td",Bs,o(r.notes||"-"),1)]))),128))])]),t("p",Ks,"共 "+o(b.value.length)+" 条记录",1)])):D("",!0),t("div",js,[t("button",{class:"text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400",type:"button",onClick:e[6]||(e[6]=r=>a.value=!1)},e[23]||(e[23]=[t("i",{class:"fas fa-arrow-left"},null,-1),R(" 返回单个录入 ",-1)]))])])):(i(),d("div",Cs,[t("form",{onSubmit:X(u,["prevent"])},[t("div",Ps,[e[10]||(e[10]=t("label",{class:"form-label"},"计费周期",-1)),C(t("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>y.billingPeriod=r),class:"form-input",placeholder:"2025-01",required:"",type:"month"},null,512),[[V,y.billingPeriod]]),e[11]||(e[11]=t("p",{class:"form-hint"},"格式：YYYY-MM（如 2025-01）",-1))]),t("div",Fs,[e[12]||(e[12]=t("label",{class:"form-label"},"实际账单金额 ($)",-1)),C(t("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>y.totalCost=r),class:"form-input",placeholder:"123.45",required:"",step:"0.01",type:"number"},null,512),[[V,y.totalCost,void 0,{number:!0}]]),e[13]||(e[13]=t("p",{class:"form-hint"},"从账单中获取的实际费用",-1))]),t("div",Ss,[e[15]||(e[15]=t("label",{class:"form-label"},"币种",-1)),C(t("select",{"onUpdate:modelValue":e[3]||(e[3]=r=>y.currency=r),class:"form-input"},e[14]||(e[14]=[t("option",{value:"USD"},"美元 (USD)",-1),t("option",{value:"CNY"},"人民币 (CNY)",-1),t("option",{value:"EUR"},"欧元 (EUR)",-1)]),512),[[M,y.currency]])]),t("div",As,[e[16]||(e[16]=t("label",{class:"form-label"},"账单备注",-1)),C(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=r=>y.notes=r),class:"form-input",placeholder:"记录账单来源、特殊情况等",rows:"3"},null,512),[[V,y.notes]])]),t("div",Ts,[e[17]||(e[17]=t("label",{class:"form-label"},"账单文件（可选）",-1)),t("input",{accept:".pdf,.png,.jpg,.jpeg",class:"form-input",type:"file",onChange:m},null,32),e[18]||(e[18]=t("p",{class:"form-hint"},"支持PDF、图片格式",-1))])],32),t("div",Us,[t("button",{class:"text-sm text-indigo-600 hover:text-indigo-700 dark:text-indigo-400",type:"button",onClick:e[5]||(e[5]=r=>a.value=!0)},e[19]||(e[19]=[t("i",{class:"fas fa-upload"},null,-1),R(" 切换到批量导入 ",-1)]))])]))]),t("div",zs,[t("button",{class:"btn-secondary",type:"button",onClick:e[7]||(e[7]=r=>s.$emit("close"))},"取消"),t("button",{class:"btn-primary",disabled:c.value||a.value&&b.value.length===0,type:"button",onClick:u},[t("i",{class:T(["fas fa-save",{"fa-spin":c.value}])},null,2),R(" "+o(c.value?"提交中...":a.value?`批量提交 (${b.value.length})`:"提交账单"),1)],8,Es)])])]))}},Os=Y(Ns,[["__scopeId","data-v-93b9649c"]]),Ys={class:"modal-content-large"},Qs={class:"modal-header"},Gs={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},Hs={class:"modal-body"},Ws={class:"mb-6"},Xs={class:"flex gap-3"},Zs=["disabled"],Js={key:0,class:"space-y-6"},ta={class:"grid grid-cols-1 gap-4 md:grid-cols-3"},ea={class:"stat-card"},sa={class:"stat-value text-blue-600 dark:text-blue-400"},aa={class:"stat-card"},oa={class:"stat-value text-green-600 dark:text-green-400"},la={class:"stat-card"},ra={class:"stat-hint"},na={key:0,class:"quality-section"},ia={class:"grid grid-cols-1 gap-4 md:grid-cols-3"},da={class:"quality-metric"},ua={class:"flex items-center justify-between"},ca={class:"text-sm font-bold text-gray-900 dark:text-gray-100"},ga={class:"progress-bar mt-2"},xa={class:"quality-metric"},pa={class:"flex items-center justify-between"},ya={class:"text-sm font-bold text-gray-900 dark:text-gray-100"},ma={class:"progress-bar mt-2"},va={class:"quality-metric"},fa={class:"flex items-center justify-between"},ba={class:"text-sm font-bold text-gray-900 dark:text-gray-100"},ka={class:"progress-bar mt-2"},ha={class:"details-section"},$a={class:"grid grid-cols-1 gap-3 text-sm md:grid-cols-2"},_a={class:"detail-item"},wa={class:"detail-value"},Ca={class:"detail-item"},Pa={class:"detail-value"},Fa={class:"detail-item"},Sa={class:"detail-value"},Aa={class:"detail-item"},Ta={key:1,class:"comparison-section"},Ua={class:"mb-4 flex items-center justify-between"},Va={key:2,class:"suggestions-section"},Da={class:"space-y-2"},Ra={key:1,class:"empty-state"},Ia={class:"modal-footer"},qa={__name:"InferenceValidationPanel",props:{account:{type:Object,required:!0}},emits:["close"],setup(P){const f=P,x=$(!1),k=$(""),c=$(null),a=$(null),b=$(!1),y=$(null);let m=null;async function F(){var w,n;if(!k.value){alert("请选择验证周期");return}x.value=!0;try{const l=await E.validateCosts(f.account.id,k.value);if(console.log("Validation result:",l),!l){alert("验证失败：未收到服务器响应");return}if(l.validated===!1&&l.reason==="database_disabled"){alert(`成本验证功能需要 PostgreSQL 数据库支持。

请在环境变量中设置 POSTGRES_ENABLED=true 并配置数据库连接参数后重启服务。`);return}if(l.validated===!1&&l.reason==="no_bill_data"){alert(l.message||`未找到 ${k.value} 的账单数据。

请先录入该周期的账单数据。`);return}c.value=l,e(),await u()}catch(l){console.error("Validation error:",l),alert(`验证失败: ${((n=(w=l.response)==null?void 0:w.data)==null?void 0:n.error)||l.message}`)}finally{x.value=!1}}async function u(){b.value=!0;try{const w=new Date(k.value+"-01"),n=new Date(w);n.setMonth(n.getMonth()-5);const l=await E.getCostComparison(f.account.id,n.toISOString().slice(0,10),w.toISOString().slice(0,10));a.value=l,await lt(),s()}catch(w){console.error("Failed to load comparison:",w)}finally{b.value=!1}}function s(){if(!y.value||!a.value)return;m&&m.dispose(),m=it(y.value);const w={tooltip:{trigger:"axis",backgroundColor:"rgba(0, 0, 0, 0.8)",textStyle:{color:"#fff"}},legend:{data:["计算成本","实际账单"],textStyle:{color:document.documentElement.classList.contains("dark")?"#9CA3AF":"#4B5563"}},xAxis:{type:"category",data:a.value.periods||[],axisLabel:{color:document.documentElement.classList.contains("dark")?"#9CA3AF":"#6B7280"}},yAxis:{type:"value",name:"成本 ($)",axisLabel:{color:document.documentElement.classList.contains("dark")?"#9CA3AF":"#6B7280"}},series:[{name:"计算成本",type:"line",data:a.value.calculatedCosts||[],smooth:!0,itemStyle:{color:"#3B82F6"}},{name:"实际账单",type:"line",data:a.value.actualBills||[],smooth:!0,itemStyle:{color:"#10B981"}}]};m.setOption(w)}function e(){var l;if(!c.value)return;const w=[],n=Math.abs(c.value.deviationPercent||0);n>20?w.push("偏差较大，建议重新推导计价参数或检查账单数据准确性"):n>10?w.push("偏差适中，可考虑录入更多账单数据以提高推导精度"):n<5&&w.push("计算精度优秀，当前配置可靠"),((l=c.value.quality)==null?void 0:l.r_squared)<.8&&w.push("R²系数较低，推导模型可能不够准确，建议手动调整参数"),c.value.suggestions=w}function r(w){const n=Math.abs(w||0);return n<5?"text-green-600 dark:text-green-400":n<10?"text-yellow-600 dark:text-yellow-400":n<20?"text-orange-600 dark:text-orange-400":"text-red-600 dark:text-red-400"}function U(w){return{high:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300","medium-high":"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",medium:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300","low-medium":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",low:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"}[w]||"bg-gray-100 text-gray-800"}function I(w){return{high:"高","medium-high":"较高",medium:"中等","low-medium":"较低",low:"低"}[w]||w}return N(()=>{const w=new Date;k.value=`${w.getFullYear()}-${String(w.getMonth()+1).padStart(2,"0")}`}),(w,n)=>{var l,p;return i(),d("div",{class:"modal-overlay",onClick:n[3]||(n[3]=X(_=>w.$emit("close"),["self"]))},[t("div",Ys,[t("div",Qs,[t("h3",Gs," 成本验证 - "+o(P.account.name),1),t("button",{class:"close-btn",onClick:n[0]||(n[0]=_=>w.$emit("close"))},n[4]||(n[4]=[t("i",{class:"fas fa-times"},null,-1)]))]),t("div",Hs,[t("div",Ws,[n[5]||(n[5]=t("label",{class:"form-label"},"选择验证周期",-1)),t("div",Xs,[C(t("input",{"onUpdate:modelValue":n[1]||(n[1]=_=>k.value=_),class:"form-input flex-1",placeholder:"2025-01",type:"month"},null,512),[[V,k.value]]),t("button",{class:"btn-primary",disabled:x.value,onClick:F},[t("i",{class:T(["fas fa-play",{"fa-spin":x.value}])},null,2),R(" "+o(x.value?"验证中...":"开始验证"),1)],8,Zs)])]),c.value?(i(),d("div",Js,[t("div",ta,[t("div",ea,[n[6]||(n[6]=t("div",{class:"stat-label"},"计算成本",-1)),t("div",sa," $"+o(((l=c.value.calculatedCost)==null?void 0:l.toFixed(4))||"0.0000"),1),n[7]||(n[7]=t("div",{class:"stat-hint"},"基于使用量计算",-1))]),t("div",aa,[n[8]||(n[8]=t("div",{class:"stat-label"},"实际账单",-1)),t("div",oa," $"+o(((p=c.value.actualBill)==null?void 0:p.toFixed(4))||"0.0000"),1),n[9]||(n[9]=t("div",{class:"stat-hint"},"从账单记录获取",-1))]),t("div",la,[n[10]||(n[10]=t("div",{class:"stat-label"},"偏差率",-1)),t("div",{class:T(["stat-value",r(c.value.deviationPercent)])},o(Math.abs(c.value.deviationPercent||0).toFixed(2))+"% ",3),t("div",ra,o(c.value.deviationPercent>0?"高估":"低估"),1)])]),c.value.quality?(i(),d("div",na,[n[14]||(n[14]=t("h4",{class:"mb-4 text-sm font-semibold text-gray-900 dark:text-gray-100"}," 推导质量评分 ",-1)),t("div",ia,[t("div",da,[t("div",ua,[n[11]||(n[11]=t("span",{class:"text-xs text-gray-600 dark:text-gray-400"},"总分",-1)),t("span",ca,o((c.value.quality.score*100).toFixed(1))+"% ",1)]),t("div",ga,[t("div",{class:"progress-fill bg-green-500",style:H({width:c.value.quality.score*100+"%"})},null,4)])]),t("div",xa,[t("div",pa,[n[12]||(n[12]=t("span",{class:"text-xs text-gray-600 dark:text-gray-400"},"R² 决定系数",-1)),t("span",ya,o((c.value.quality.r_squared*100).toFixed(1))+"% ",1)]),t("div",ma,[t("div",{class:"progress-fill bg-blue-500",style:H({width:c.value.quality.r_squared*100+"%"})},null,4)])]),t("div",va,[t("div",fa,[n[13]||(n[13]=t("span",{class:"text-xs text-gray-600 dark:text-gray-400"},"平均绝对误差",-1)),t("span",ba,o((c.value.quality.mean_absolute_error*100).toFixed(2))+"% ",1)]),t("div",ka,[t("div",{class:"progress-fill bg-yellow-500",style:H({width:(1-c.value.quality.mean_absolute_error)*100+"%"})},null,4)])])])])):D("",!0),t("div",ha,[n[19]||(n[19]=t("h4",{class:"mb-3 text-sm font-semibold text-gray-900 dark:text-gray-100"},"验证详情",-1)),t("div",$a,[t("div",_a,[n[15]||(n[15]=t("span",{class:"detail-label"},"计费周期:",-1)),t("span",wa,o(c.value.billingPeriod),1)]),t("div",Ca,[n[16]||(n[16]=t("span",{class:"detail-label"},"计算方法:",-1)),t("span",Pa,o(c.value.calculationMethod),1)]),t("div",Fa,[n[17]||(n[17]=t("span",{class:"detail-label"},"数据来源:",-1)),t("span",Sa,o(c.value.costSource),1)]),t("div",Aa,[n[18]||(n[18]=t("span",{class:"detail-label"},"置信度:",-1)),t("span",{class:T(["inline-flex rounded-full px-2 py-0.5 text-xs font-semibold",U(c.value.confidenceLevel)])},o(I(c.value.confidenceLevel)),3)])])]),a.value?(i(),d("div",Ta,[t("div",Ua,[n[21]||(n[21]=t("h4",{class:"text-sm font-semibold text-gray-900 dark:text-gray-100"},"成本对比趋势",-1)),t("button",{class:"btn-sm btn-secondary",onClick:u},[t("i",{class:T(["fas fa-sync-alt",{"fa-spin":b.value}])},null,2),n[20]||(n[20]=R(" 刷新 ",-1))])]),t("div",{ref_key:"chartContainer",ref:y,class:"chart-container"},null,512)])):D("",!0),c.value.suggestions?(i(),d("div",Va,[n[23]||(n[23]=t("h4",{class:"mb-3 text-sm font-semibold text-gray-900 dark:text-gray-100"},[t("i",{class:"fas fa-lightbulb text-yellow-500"}),R(" 优化建议 ")],-1)),t("ul",Da,[(i(!0),d(L,null,B(c.value.suggestions,(_,q)=>(i(),d("li",{key:q,class:"flex items-start gap-2 text-sm text-gray-600 dark:text-gray-400"},[n[22]||(n[22]=t("i",{class:"fas fa-check-circle mt-0.5 text-green-500"},null,-1)),t("span",null,o(_),1)]))),128))])])):D("",!0)])):(i(),d("div",Ra,n[24]||(n[24]=[t("i",{class:"fas fa-chart-line mb-3 text-4xl text-gray-300 dark:text-gray-600"},null,-1),t("p",{class:"text-sm text-gray-500 dark:text-gray-400"},' 选择计费周期并点击"开始验证"以查看结果 ',-1)])))]),t("div",Ia,[t("button",{class:"btn-secondary",type:"button",onClick:n[2]||(n[2]=_=>w.$emit("close"))},"关闭")])])])}}},Ma=Y(qa,[["__scopeId","data-v-55a1ec88"]]),La={class:"cost-tracking-management"},Ba={class:"card p-6"},Ka={class:"mb-6 flex items-center justify-between"},ja={class:"flex gap-3"},za=["disabled"],Ea={key:0,class:"flex h-64 items-center justify-center"},Na={key:1,class:"overflow-x-auto"},Oa={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},Ya={class:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"},Qa={class:"px-4 py-3"},Ga={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},Ha={class:"text-xs text-gray-500 dark:text-gray-400"},Wa={class:"px-4 py-3"},Xa={class:"px-4 py-3"},Za={class:"text-sm text-gray-900 dark:text-gray-100"},Ja={class:"px-4 py-3"},to={key:1,class:"text-xs text-gray-400"},eo={class:"px-4 py-3 text-sm text-gray-600 dark:text-gray-400"},so={class:"px-4 py-3 text-right"},ao={class:"flex justify-end gap-2"},oo=["onClick"],lo=["onClick"],ro=["disabled","onClick"],no=["onClick"],io={key:0,class:"py-12 text-center"},uo={__name:"CostTrackingManagement",setup(P){const f=$(!1),x=$([]),k=$({platform:"all"}),c=$(null),a=$(!1),b=$(!1),y=$(!1),m=$(null),F=W(()=>k.value.platform==="all"?x.value:x.value.filter(v=>v.platform===k.value.platform));async function u(){f.value=!0;try{let v=[];try{const g=await A.get("/admin/claude-accounts");g.success&&g.data&&v.push(...g.data.map(S=>({...S,platform:S.platform||"claude"})))}catch(g){console.warn("Failed to load Claude accounts:",g.message)}try{const g=await A.get("/admin/claude-console-accounts");g.success&&g.data&&v.push(...g.data.map(S=>({...S,platform:S.platform||"claude-console"})))}catch(g){console.warn("Failed to load Claude Console accounts:",g.message)}try{const g=await A.get("/admin/gemini-accounts");g.success&&g.data&&v.push(...g.data.map(S=>({...S,platform:S.platform||"gemini"})))}catch(g){console.warn("Failed to load Gemini accounts:",g.message)}try{const g=await A.get("/admin/openai-accounts");g.success&&g.data&&v.push(...g.data.map(S=>({...S,platform:S.platform||"openai"})))}catch(g){console.warn("Failed to load OpenAI accounts:",g.message)}try{const g=await A.get("/admin/openai-responses-accounts");g.success&&g.data&&v.push(...g.data.map(S=>({...S,platform:S.platform||"openai-responses"})))}catch(g){console.warn("Failed to load OpenAI Responses accounts:",g.message)}if(console.log("All accounts:",v),v.length===0){x.value=[],f.value=!1;return}const h=await Promise.all(v.map(async g=>{try{const S=await E.getAccountCostProfile(g.id);return{...g,costProfile:(S==null?void 0:S.profile)||null}}catch(S){return console.log(`No cost profile for account ${g.id}:`,S.message),{...g,costProfile:null}}}));x.value=h,console.log("Accounts with profiles:",h)}catch(v){console.error("Unexpected error loading accounts:",v)}finally{f.value=!1}}function s(v){c.value=v,a.value=!0}function e(v){c.value=v,b.value=!0}function r(v){c.value=v,y.value=!0}async function U(v){var h,g,S,Q;if(confirm(`确定要为账户 "${v.name}" 推导计价参数吗？这将基于历史账单数据进行分析。`)){m.value=v.id;try{const K=await E.inferPricing(v.id);alert(`推导成功！
质量分数: ${(((h=K.quality)==null?void 0:h.score)*100||0).toFixed(1)}%
R²: ${(((g=K.quality)==null?void 0:g.r_squared)*100||0).toFixed(1)}%`),await u()}catch(K){alert(`推导失败: ${((Q=(S=K.response)==null?void 0:S.data)==null?void 0:Q.error)||K.message}`)}finally{m.value=null}}}function I(){a.value=!1,u()}function w(){b.value=!1}function n(v){return{claude:"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300","claude-console":"bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300",gemini:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",openai:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"}[v]||"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}function l(v){return{high:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300","medium-high":"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",medium:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300","low-medium":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",low:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"}[v]||"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}function p(v){return{high:"高","medium-high":"较高",medium:"中等","low-medium":"较低",low:"低"}[v]||v}function _(v){return{standard:"标准定价",point_based:"积分制",tiered:"阶梯定价",hybrid:"混合计费",estimated:"估算模式"}[v]||"未配置"}function q(v){return v?new Date(v).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}):"-"}return N(()=>{u()}),(v,h)=>(i(),d("div",La,[t("div",Ba,[t("div",Ka,[h[6]||(h[6]=t("div",null,[t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"成本配置与验证"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"}," 管理账户计价模式、录入账单、推导参数和验证成本准确性 ")],-1)),t("div",ja,[C(t("select",{"onUpdate:modelValue":h[0]||(h[0]=g=>k.value.platform=g),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200",onChange:u},h[4]||(h[4]=[O('<option value="all" data-v-6e67f7b6>全部平台</option><option value="claude" data-v-6e67f7b6>Claude</option><option value="claude-console" data-v-6e67f7b6>Console</option><option value="gemini" data-v-6e67f7b6>Gemini</option><option value="openai" data-v-6e67f7b6>OpenAI</option><option value="openai-responses" data-v-6e67f7b6>OpenAI Responses</option>',6)]),544),[[M,k.value.platform]]),t("button",{class:"btn-primary flex items-center gap-2",disabled:f.value,onClick:u},[t("i",{class:T(["fas fa-sync-alt",{"fa-spin":f.value}])},null,2),h[5]||(h[5]=R(" 刷新 ",-1))],8,za)])]),f.value?(i(),d("div",Ea,h[7]||(h[7]=[t("div",{class:"loading-spinner h-12 w-12 border-4 border-indigo-500"},null,-1)]))):(i(),d("div",Na,[t("table",Oa,[h[11]||(h[11]=t("thead",{class:"bg-gray-50 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 账户 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 平台 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 计价模式 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 置信度 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 最后验证 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 操作 ")])],-1)),t("tbody",Ya,[(i(!0),d(L,null,B(F.value,g=>{var S,Q,K;return i(),d("tr",{key:g.id,class:"hover:bg-gray-50 dark:hover:bg-gray-800"},[t("td",Qa,[t("div",Ga,o(g.name),1),t("div",Ha,o(g.id),1)]),t("td",Wa,[t("span",{class:T(["inline-flex rounded-full px-2 py-1 text-xs font-semibold",n(g.platform)])},o(g.platform),3)]),t("td",Xa,[t("span",Za,o(_((S=g.costProfile)==null?void 0:S.billingType)),1)]),t("td",Ja,[(Q=g.costProfile)!=null&&Q.confidenceLevel?(i(),d("span",{key:0,class:T(["inline-flex rounded-full px-2 py-1 text-xs font-semibold",l(g.costProfile.confidenceLevel)])},o(p(g.costProfile.confidenceLevel)),3)):(i(),d("span",to,"-"))]),t("td",eo,o((K=g.costProfile)!=null&&K.lastValidatedAt?q(g.costProfile.lastValidatedAt):"-"),1),t("td",so,[t("div",ao,[t("button",{class:"btn-sm btn-secondary",title:"配置成本",onClick:Z=>s(g)},h[8]||(h[8]=[t("i",{class:"fas fa-cog"},null,-1)]),8,oo),t("button",{class:"btn-sm btn-secondary",title:"录入账单",onClick:Z=>e(g)},h[9]||(h[9]=[t("i",{class:"fas fa-file-invoice-dollar"},null,-1)]),8,lo),t("button",{class:"btn-sm btn-secondary",disabled:m.value===g.id,title:"推导参数",onClick:Z=>U(g)},[t("i",{class:T(["fas fa-robot",{"fa-spin":m.value===g.id}])},null,2)],8,ro),t("button",{class:"btn-sm btn-primary",title:"验证成本",onClick:Z=>r(g)},h[10]||(h[10]=[t("i",{class:"fas fa-check-circle"},null,-1)]),8,no)])])])}),128))])]),F.value.length===0?(i(),d("div",io,h[12]||(h[12]=[t("i",{class:"fas fa-inbox mb-3 text-4xl text-gray-300 dark:text-gray-600"},null,-1),t("p",{class:"text-sm text-gray-500 dark:text-gray-400"},"暂无账户数据",-1)]))):D("",!0)]))]),a.value?(i(),J(ks,{key:0,account:c.value,onClose:h[1]||(h[1]=g=>a.value=!1),onSaved:I},null,8,["account"])):D("",!0),b.value?(i(),J(Os,{key:1,account:c.value,onClose:h[2]||(h[2]=g=>b.value=!1),onSaved:w},null,8,["account"])):D("",!0),y.value?(i(),J(Ma,{key:2,account:c.value,onClose:h[3]||(h[3]=g=>y.value=!1)},null,8,["account"])):D("",!0)]))}},co=Y(uo,[["__scopeId","data-v-6e67f7b6"]]),go={class:"quota-allocation-analysis"},xo={class:"card p-6"},po={key:0,class:"flex h-64 items-center justify-center"},yo={key:1},mo={class:"mb-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4"},vo={class:"rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 p-4 dark:from-blue-900/20 dark:to-indigo-900/20"},fo={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},bo={class:"rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 p-4 dark:from-green-900/20 dark:to-emerald-900/20"},ko={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},ho={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},$o={class:"rounded-lg bg-gradient-to-br from-purple-50 to-pink-50 p-4 dark:from-purple-900/20 dark:to-pink-900/20"},_o={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},wo={class:"rounded-lg bg-gradient-to-br from-orange-50 to-yellow-50 p-4 dark:from-orange-900/20 dark:to-yellow-900/20"},Co={class:"mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"},Po={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},Fo={class:"mb-4 flex flex-wrap items-center gap-3"},So={class:"overflow-x-auto"},Ao={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-700"},To={class:"divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"},Uo={class:"px-4 py-3"},Vo={class:"text-sm font-medium text-gray-900 dark:text-gray-100"},Do={class:"text-xs text-gray-500 dark:text-gray-400"},Ro={class:"px-4 py-3"},Io={class:"px-4 py-3 text-sm text-gray-900 dark:text-gray-100"},qo={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Mo={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Lo={class:"px-4 py-3 text-right text-sm font-medium text-gray-900 dark:text-gray-100"},Bo={class:"px-4 py-3 text-right"},Ko={class:"flex items-center justify-end gap-2"},jo={class:"h-2 w-20 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"},zo={class:"text-sm text-gray-900 dark:text-gray-100"},Eo={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},No={class:"px-4 py-3 text-right text-sm text-gray-900 dark:text-gray-100"},Oo={class:"px-4 py-3 text-right"},Yo={class:"flex items-center justify-end gap-2"},Qo={class:"h-2 w-20 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700"},Go={class:"text-sm text-gray-900 dark:text-gray-100"},Ho={key:0,class:"py-12 text-center"},Wo={class:"mt-4 text-center text-xs text-gray-500 dark:text-gray-400"},Xo={key:2,class:"py-12 text-center"},Zo={key:0,class:"mt-2 text-sm text-red-500"},Jo={__name:"QuotaAllocationAnalysis",setup(P){const f=$(!1),x=$(null),k=$(""),c=$("all"),a=$("dailyRemaining"),b=$(""),y=$(""),m=W(()=>{var s;if(!((s=x.value)!=null&&s.keyDetails))return[];let u=[...x.value.keyDetails];if(c.value!=="all"&&(u=u.filter(e=>e.status===c.value)),k.value){const e=k.value.toLowerCase();u=u.filter(r=>r.name.toLowerCase().includes(e)||r.owner.toLowerCase().includes(e)||r.id.toLowerCase().includes(e))}return u.sort((e,r)=>{switch(a.value){case"dailyRemaining":return r.dailyRemaining-e.dailyRemaining;case"dailyUtilization":return parseFloat(r.dailyUtilization)-parseFloat(e.dailyUtilization);case"totalRemaining":return r.totalRemaining-e.totalRemaining;case"name":return e.name.localeCompare(r.name);default:return 0}}),u}),F=async()=>{f.value=!0,y.value="";try{const u=await A.get("/admin/quota-allocation-stats");u.success?(x.value=u.data,b.value=new Date(u.timestamp).toLocaleString("zh-CN")):(y.value=u.error||"加载失败",x.value=null)}catch(u){console.error("Failed to load quota allocation stats:",u),y.value=u.message||"网络请求失败",x.value=null}finally{f.value=!1}};return N(()=>{F()}),(u,s)=>(i(),d("div",go,[t("div",xo,[t("div",{class:"mb-6 flex items-center justify-between"},[s[4]||(s[4]=t("div",null,[t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"额度配置监控"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"}," 监控各API Key的额度配置情况,避免超额分配 ")],-1)),t("button",{class:"rounded-lg bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600",onClick:F},s[3]||(s[3]=[t("i",{class:"fas fa-sync-alt mr-2"},null,-1),R(" 刷新数据 ",-1)]))]),f.value?(i(),d("div",po,s[5]||(s[5]=[t("div",{class:"loading-spinner h-12 w-12 border-4 border-indigo-500"},null,-1)]))):x.value?(i(),d("div",yo,[t("div",mo,[t("div",vo,[s[6]||(s[6]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"活跃API Keys",-1)),t("div",fo,o(x.value.activeKeys)+" / "+o(x.value.totalKeys),1)]),t("div",bo,[s[7]||(s[7]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"日额度配置总计",-1)),t("div",ko," $"+o(x.value.totalDailyQuotaAllocated.toFixed(2)),1),t("div",ho," 已用: $"+o(x.value.totalDailyUsed.toFixed(2))+" ("+o(x.value.dailyUtilizationRate)+"%) ",1)]),t("div",$o,[s[8]||(s[8]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"日剩余额度",-1)),t("div",_o," $"+o(x.value.totalDailyRemaining.toFixed(2)),1),t("div",{class:T(["mt-1 text-xs",x.value.dailyUtilizationRate>80?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400"])},[t("i",{class:T(x.value.dailyUtilizationRate>80?"fas fa-exclamation-triangle":"fas fa-check-circle")},null,2),R(" "+o(x.value.dailyUtilizationRate>80?"使用率偏高":"使用正常"),1)],2)]),t("div",wo,[s[9]||(s[9]=t("div",{class:"text-sm text-gray-600 dark:text-gray-400"},"本月总使用",-1)),t("div",Co," $"+o((x.value.totalMonthlyUsed||0).toFixed(2)),1),t("div",Po," 活跃Key: "+o(x.value.activeKeys)+"个 ",1)])]),t("div",Fo,[C(t("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>k.value=e),class:"flex-1 rounded-lg border border-gray-300 px-4 py-2 text-sm dark:border-gray-600 dark:bg-gray-800",placeholder:"搜索 API Key 名称或所有者...",type:"text"},null,512),[[V,k.value]]),C(t("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>c.value=e),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800"},s[10]||(s[10]=[t("option",{value:"all"},"全部状态",-1),t("option",{value:"active"},"活跃",-1),t("option",{value:"inactive"},"未激活",-1)]),512),[[M,c.value]]),C(t("select",{"onUpdate:modelValue":s[2]||(s[2]=e=>a.value=e),class:"rounded-lg border border-gray-300 px-3 py-2 text-sm dark:border-gray-600 dark:bg-gray-800"},s[11]||(s[11]=[t("option",{value:"dailyRemaining"},"按日剩余额度",-1),t("option",{value:"dailyUtilization"},"按日使用率",-1),t("option",{value:"totalRemaining"},"按总剩余额度",-1),t("option",{value:"name"},"按名称",-1)]),512),[[M,a.value]])]),t("div",So,[t("table",Ao,[s[12]||(s[12]=t("thead",{class:"bg-gray-50 dark:bg-gray-800"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," API Key "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 状态 "),t("th",{class:"px-4 py-3 text-left text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 所有者 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 日额度 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 日已用 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 日剩余 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 日使用率 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总额度 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总已用 "),t("th",{class:"px-4 py-3 text-right text-xs font-medium uppercase text-gray-500 dark:text-gray-400"}," 总使用率 ")])],-1)),t("tbody",To,[(i(!0),d(L,null,B(m.value,e=>(i(),d("tr",{key:e.id,class:"hover:bg-gray-50 dark:hover:bg-gray-800"},[t("td",Uo,[t("div",Vo,o(e.name),1),t("div",Do,o(e.id.substring(0,8))+"... ",1)]),t("td",Ro,[t("span",{class:T(["inline-flex rounded-full px-2 py-1 text-xs font-semibold",e.status==="active"?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400"])},o(e.status==="active"?"活跃":"未激活"),3)]),t("td",Io,o(e.owner),1),t("td",qo," $"+o(e.dailyLimit.toFixed(2)),1),t("td",Mo," $"+o(e.dailyUsed.toFixed(2)),1),t("td",Lo," $"+o(e.dailyRemaining.toFixed(2)),1),t("td",Bo,[t("div",Ko,[t("div",jo,[t("div",{class:T(["h-full transition-all",parseFloat(e.dailyUtilization)>80?"bg-red-500":parseFloat(e.dailyUtilization)>50?"bg-yellow-500":"bg-green-500"]),style:H({width:Math.min(100,parseFloat(e.dailyUtilization))+"%"})},null,6)]),t("span",zo,o(e.dailyUtilization)+"% ",1)])]),t("td",Eo," $"+o(e.totalLimit.toFixed(2)),1),t("td",No," $"+o(e.totalAccumulated.toFixed(2)),1),t("td",Oo,[t("div",Yo,[t("div",Qo,[t("div",{class:T(["h-full transition-all",parseFloat(e.totalUtilization)>80?"bg-red-500":parseFloat(e.totalUtilization)>50?"bg-yellow-500":"bg-green-500"]),style:H({width:Math.min(100,parseFloat(e.totalUtilization))+"%"})},null,6)]),t("span",Go,o(e.totalUtilization)+"% ",1)])])]))),128))])])]),m.value.length===0?(i(),d("div",Ho,s[13]||(s[13]=[t("i",{class:"fas fa-search mb-3 text-4xl text-gray-400"},null,-1),t("p",{class:"text-gray-600 dark:text-gray-400"},"没有找到匹配的API Key",-1)]))):D("",!0),t("div",Wo," 最后更新: "+o(b.value),1)])):(i(),d("div",Xo,[s[14]||(s[14]=t("i",{class:"fas fa-exclamation-triangle mb-3 text-4xl text-yellow-500"},null,-1)),s[15]||(s[15]=t("p",{class:"text-gray-600 dark:text-gray-400"},"加载数据失败,请稍后重试",-1)),y.value?(i(),d("p",Zo,o(y.value),1)):D("",!0),t("button",{class:"mt-4 rounded-lg bg-indigo-600 px-4 py-2 text-sm text-white hover:bg-indigo-700",onClick:F}," 重试 ")]))])]))}},tl=Y(Jo,[["__scopeId","data-v-b7b2a478"]]),el={class:"analytics-container"},sl={class:"mb-6"},al={class:"border-b border-gray-200 dark:border-gray-700"},ol={"aria-label":"Tabs",class:"-mb-px flex space-x-8"},ll=["onClick"],rl={class:"tab-content"},nl={class:"space-y-6"},il={class:"space-y-6"},dl={class:"space-y-6"},ul={key:0,class:"space-y-6"},cl={key:1,class:"space-y-6"},gl={__name:"AnalyticsView",setup(P){const f=$("cost-efficiency"),x=[{id:"cost-efficiency",name:"账户性价比对比",icon:"fas fa-chart-line"},{id:"api-key-breakdown",name:"API Key 调用明细",icon:"fas fa-key"},{id:"cost-trends",name:"成本趋势分析",icon:"fas fa-chart-area"},{id:"cost-tracking",name:"成本配置与验证",icon:"fas fa-cog"},{id:"quota-allocation",name:"额度配置监控",icon:"fas fa-balance-scale"}];return(k,c)=>(i(),d("div",el,[c[0]||(c[0]=t("div",{class:"mb-6"},[t("h2",{class:"text-2xl font-bold text-gray-900 dark:text-gray-100"},"统计分析"),t("p",{class:"mt-1 text-sm text-gray-600 dark:text-gray-400"}," 深度分析账户性价比、API Key 使用情况和成本趋势 ")],-1)),t("div",sl,[t("div",al,[t("nav",ol,[(i(),d(L,null,B(x,a=>t("button",{key:a.id,class:T([f.value===a.id?"border-indigo-500 text-indigo-600 dark:text-indigo-400":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300","group inline-flex items-center border-b-2 px-1 py-4 text-sm font-medium transition-colors"]),onClick:b=>f.value=a.id},[t("i",{class:T([a.icon,"mr-2"])},null,2),R(" "+o(a.name),1)],10,ll)),64))])])]),t("div",rl,[C(t("div",nl,[G(Rt)],512),[[tt,f.value==="cost-efficiency"]]),C(t("div",il,[G(Te)],512),[[tt,f.value==="api-key-breakdown"]]),C(t("div",dl,[G(Qe)],512),[[tt,f.value==="cost-trends"]]),f.value==="cost-tracking"?(i(),d("div",ul,[G(co)])):D("",!0),f.value==="quota-allocation"?(i(),d("div",cl,[G(tl)])):D("",!0)])]))}},fl=Y(gl,[["__scopeId","data-v-4312a96d"]]);export{fl as default};
